---
title: "p8105_hw6_sal2222"
author: "Stephen Lewandowski"
date: "November 16, 2018"
output:  github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

library(MASS)
library(tidyverse)


theme_set(theme_bw() + theme(legend.position = "bottom"))
```

### Problem 1 - Homicide data

This problem utilizes data from _The Washington Post_ on homicides in 50 U.S. cities. The code chunk below imports and cleans the data. I referred to the posted solution of Homework 5, Problem 2 for some of the data cleaning code structure and naming conventions.

```{r clean_homicide, message = FALSE}
homicide_df <- 
  read_csv("data/homicide-data.csv", na = c("", "NA", "Unknown")) %>%
  mutate(
    city_state = str_c(city, state, sep = ", "),
    resolution = factor(case_when(
      disposition == "Closed without arrest" ~ "unsolved",
      disposition == "Open/No arrest"        ~ "unsolved",
      disposition == "Closed by arrest"      ~ "solved"
    )),
    victim_race = factor(case_when(
      victim_race == "White" ~ "white",
      victim_race != "white" ~ "non-white"
    )),
    victim_race = fct_relevel(victim_race, "white"),
    victim_age = as.numeric(victim_age),
    victim_sex = factor(victim_sex)) %>% 
  filter(!city_state %in% c("Tulsa, AL", "Dallas, TX", "Phoenix, AZ", "Kansas City, MO")) 
```

I excluded cities that do not report race as well as a data entry error ("Tulsa, AL").

## Baltimore model

For the city of Baltimore, MD, I will the glm function to fit a logistic regression with resolved vs unresolved as the outcome and victim age, sex and race as predictors. The output is saved as R object `fit_logistic`. 

```{r glm_baltimore}

fit_logistic_baltimore <- 
  homicide_df %>% 
    filter(city_state == "Baltimore, MD") %>% 
    dplyr::select(resolution, victim_age, victim_race, victim_sex) %>% 
    glm(resolution ~ victim_age + victim_race + victim_sex, data = ., family = binomial()) 

```

I will apply `broom::tidy` to `fit_logistic` and obtain the estimate and confidence interval of the adjusted odds ratio for solving homicides comparing no n-white victims to white victims keeping all other variables fixed.

```{r broom_baltimore}

broom::tidy(fit_logistic_baltimore, conf.int = TRUE) %>% 
  mutate(OR = exp(estimate),
         conf_low_OR = exp(conf.low),
         conf_high_OR = exp(conf.high)) %>%
  dplyr::select(term, OR, conf_low_OR, conf_high_OR) %>%
  filter(term == "victim_racenon-white") %>% 
  knitr::kable(digits = 3)


```

## All cities

Now, I will run a glm for each of the cities in my dataset and extract the adjusted odds ratio and CI for solving homicides comparing non-white victims to white victims within a “tidy” pipeline.


```{r glm_all_cities}

nest_glm_all <-
  homicide_df %>% 
  group_by(city_state) %>% 
  nest() %>% 
  mutate(models = map(data, ~glm(resolution ~ victim_age + victim_race + victim_sex, data = ., family = binomial())),
         models = map(models, broom::tidy, conf.int = TRUE)) %>% 
  select(-data) %>% 
  unnest()

```

From these resuts, I will create a dataframe with the estimated, adjusted ORs and CIs for each city comparing unsolved cases among non-white and white victims.

```{r ORs_all_cities}
all_city_OR <-
  nest_glm_all %>% 
    mutate(OR = exp(estimate),
           conf_low_OR = exp(conf.low),
           conf_high_OR = exp(conf.high)) %>%
    dplyr::select(city_state, term, OR, conf_low_OR, conf_high_OR) %>%
    filter(term == "victim_racenon-white")  

```

The results are displayed as a `kable` table below.
```{r}
all_city_OR %>%
   knitr::kable(digits = 3)
```

I will now plot the estimated ORs and CIs for each city.

```{r OR_plot}

all_city_OR %>%
  mutate(city_state = forcats::fct_reorder(city_state, OR)) %>%
  ggplot(aes(x = city_state, y = OR)) + 
      geom_errorbar(aes(ymin = conf_low_OR, ymax = conf_high_OR), width = 0.2) +
      geom_point(size = 3, shape = 21, fill = "white") + 
  labs(
    title = "Unsolved homicides, comparing non-white victims to white victims",
    x = "City",
    y = "Adjusted odds ratio",
    caption = "Data from the Washington Post, adjusted for victim age, race, and gender."
  ) + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 8))
```

The results and plot indicate that the U.S. cities with the largest discrepencies in unsolved homicide case by victim race, after adjusting for victim age and gender are Boston, Omaha, Oakland, Pittsburgh, and Cincinnati. Boston also has the largest confidence interval about the adjusted OR. 


### Problem 2 - Birthweight data

I will now load and clean birthweight data for 4,342 children for regression analysis.

```{r}
birthweight_df <- 
  read_csv("data/birthweight.csv") %>% 
  mutate(
      babysex = factor(babysex),
      frace = factor(frace),
      malform = factor(malform),
      mrace = factor(mrace)
  )
```

There is no missing data.

```{r birthweight_na_check}
birthweight_df %>% 
  is.na() %>% summary()

```

## Proposed regression model for birthweight




## Model comparison

```{r blength_gestage_model}
lm(bwt ~ blength + gaweeks, data = birthweight_df) %>% broom::tidy()


```


```{r head_length_sex_interaction_model}

lm(bwt ~ bhead + blength + babysex + (bhead * blength) + (blength * babysex) + (bhead * babysex) +
     (bhead * blength * babysex), data = birthweight_df) %>% 
      broom::tidy()

```



Make this comparison in terms of the cross-validated prediction error; use crossv_mc and functions in purrr as appropriate.
